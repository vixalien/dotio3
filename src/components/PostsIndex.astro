---
import { getCollection } from "astro:content";
import PrettyDate from "./PrettyDate.astro";
import Tags from "./Tags.astro";
import type { CollectionEntry } from "astro:content";

const posts = (await getCollection("blog")).sort(
  (a, b) => b.data.publish_date.valueOf() - a.data.publish_date.valueOf(),
);

type Post = CollectionEntry<"blog">;

const postsByYear = Object.entries(
  posts.reduce(
    (acc, post) => {
      const year = post.data.publish_date.getFullYear().toString();
      acc[year] ??= [];
      acc[year].push(post);
      return acc;
    },
    {} as Record<string, Post[]>,
  ),
).sort(([year1], [year2]) => year2.localeCompare(year1));
---

<div class="posts">
  {
    postsByYear.map(([year, posts]) => {
      if (!posts) return null;

      return (
        <>
          <h3>{year}</h3>
          {posts.map(
            ({
              id,
              data: {
                title,
                description: snippet,
                publish_date,
                hero_image,
                tags,
              },
            }) => (
              <p>
                {hero_image ? (
                  <a href={`/blog/${id}`} class="post-image" aria-label={title}>
                    <img src={hero_image} alt={title} />
                  </a>
                ) : null}
                <a href={`/blog/${id}`} class="post-title">
                  <span>{title} &rarr;</span>
                </a>
                <br />
                <small class="intro-meta">
                  {/* {author && <span>{author || ""} at </span>} */}
                  <PrettyDate date={publish_date ?? new Date()} />
                </small>
                <br />
                <span>{snippet}</span>
                <br />
                <Tags tags={tags} />
              </p>
            ),
          )}
        </>
      );
    })
  }
</div>
